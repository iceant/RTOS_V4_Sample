# FLASH分区

| FLASH 区段名称   | 起始位置   | 大小(KB) | 结束位置   | 说明 |
| ---------------- | ---------- | -------- | ---------- | ---- |
| Bootloader(BOOT) | 0x08000000 | 48       | 0x0800BFFF |      |
| 信息区(INFO)     | 0x0800C000 | 16       | 0x0800FFFF |      |
| 应用区(APP)      | 0x08010000 | 576      | 0x0809FFFF |      |
| 备份区(BKP)      | 0x080A0000 | 384      | 0x080FFFFF |      |



# 主MCU升级逻辑

## BOOT处理逻辑

1. 启动时检查 `http://host:port/Device/[CPUID]/upgrade.json`
2. 解析JSON，读取 `v`,`sz`,`md5`,`url`等字段的值
3. 读取信息区内容，并与解析的 JSON 字段 `v`进行比较:
   1. 如果两者不一致，表示需要升级，记录需要下载
   2. 如果两者一致，表示不需要升级，跳过
4. 如果有固件需要更新，将更新后的信息保存在信息区
5. 遍历固件信息，对需要下载的内容进行下载，并保存到存储区(STORE AREA)
   1. 保存后马上读取，并进行比较，确认内容正确
   2. 对接收的内容进行MD5码计算，在下载完成后对MD5码进行校验，确保下载的内容一致
   3. 下载完成后，更新固件信息，记录为已下载，避免重复下载，并将固件信息保存到信息区
6. 遍历固件信息，对需要升级的内容进行升级
   1. 如果主APP需要升级，拷贝到对应的 FLASH 区段
   2. 如果从APP需要升级，通知从APP进行升级，进入从APP升级流程
   3. 如果从BOOT需要升级，进入从BOOT升级流程
   4. 如果主BOOT需要升级，重启进入APP，由主APP完成升级流程

### 主APP升级流程

1. 从存储区读取主APP的固件，并写入FLASH区段
2. 写入过程中计算MD5，确认写入的内容完整
3. 如果写入失败，重新执行写入
4. 如果写入失败超过3次，进入`升级失败流程`
5. 在有网络的情况下，报告升级失败

### 从APP升级流程

1. 向从APP发起升级命令，并等待响应
   1. 超过10秒没有收到响应，进行重试
   2. 重试超过3次，升级失败，进入`升级失败流程`
2. 从APP接收到升级命令后返回接收响应，等待发送数据
   1. 超过10秒没有收到响应，进行重试
   2. 重试超过3次，升级失败，进入`升级失败流程`
3. 接收到从APP发来的升级响应，开始发送数据
   1. 分包发送
   2. 发送后等待接收响应，确认接收完成，再发下一个包
   3. 如果等到超时，重试3次，无法接收到响应进入`升级失败流程`
4. 发送完成后进入下一个固件的发送流程

## APP处理逻辑

1. 启动时检查信息区，判断是否需要升级BOOT
   1. 不需要升级时直接进入应用
   2. 需要升级时进入升级流程
2. 升级BOOT流程
   1. 从 BOOT 存储区读取数据
   2. 写入 BOOT FLASH 区
   3. 写入时进行校验
   4. 写入过程进行 MD5计算，完成后确认 MD5 正确
   5. 升级完成后重启，进入BOOT区



# 从MCU升级逻辑

## BOOT处理逻辑

1. 检查信息区，是否需要升级APP
2. 发送升级请求，并等待，如果超时，进入超时处理流程，3次重试后，进入失败处理流程
3. 接收到升级数据后，写入APP区
   1. 计算MD5
   2. 比较写入内容是否正确
   3. 返回接收响应，包括成功与失败
4. 处理完成后进入 APP 区

## APP处理逻辑

1. 启动时检查是否需要升级BOOT，如果需要升级，进入BOOT升级流程
   1. 发送升级请求，并等待
      1. 超时，重试3次，重试失败，记录升级失败
   2. 接收到升级数据包，写入BOOT区
      1. 计算MD5
      2. 写入后马上读取，验证是否成功
         1. 没有成功，再次重试，重试3次，记录升级失败
      3. 返回接收响应，包括成功与失败的响应
2. 运行时接收到升级命令，记录升级信息到信息区，重启进入BOOT，由BOOT执行APP升级流程
